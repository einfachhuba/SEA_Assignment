FROM python:3.12-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
  bash \
  curl \
  ca-certificates \
  wget \
  && rm -rf /var/lib/apt/lists/*

# Install uv
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:${PATH}"

WORKDIR /app

# Copy project metadata first (better cache)
COPY pyproject.toml ./
COPY uv.lock* ./

# Create venv and install deps
RUN uv venv && . .venv/bin/activate && uv sync --frozen

# Copy app code
COPY app ./app
COPY main.py ./
COPY docker/start.sh ./start.sh
COPY .env ./

# Normalize line endings (in case file was checked out with CRLF on Windows)
RUN sed -i 's/\r$//' ./start.sh

# Make startup script executable
RUN chmod +x ./start.sh

# Healthcheck (optional)
HEALTHCHECK --interval=30s --timeout=5s --start-period=20s --retries=3 \
  CMD wget -qO- http://localhost:8501/_stcore/health || exit 1

EXPOSE 8501

ENV STREAMLIT_SERVER_HEADLESS=true \
    STREAMLIT_BROWSER_GATHER_USAGE_STATS=false

# Use startup script
CMD ["./start.sh"]